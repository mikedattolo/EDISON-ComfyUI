<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>EDISON - Offline AI Assistant</title>
    <link rel="stylesheet" href="styles.css?v=14">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="theme-device.js?v=3"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/PLYLoader.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Mobile Backdrop -->
        <div class="mobile-backdrop" id="mobileBackdrop"></div>
        
        <!-- Mobile Header (hidden on desktop) -->
        <div class="mobile-header" id="mobileHeader">
            <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
            <h1>EDISON</h1>
        </div>
        <!-- Hardware Monitor Widget -->
        <div class="hardware-monitor" id="hardwareMonitor" style="display: none;">
            <div class="hw-header">
                <span class="hw-title">System Monitor</span>
                <button class="hw-close" id="hwCloseBtn">√ó</button>
            </div>
            <div class="hw-stats">
                <div class="hw-stat">
                    <span class="hw-label">CPU</span>
                    <div class="hw-bar"><div class="hw-fill" id="cpuBar"></div></div>
                    <span class="hw-value" id="cpuValue">0%</span>
                </div>
                <div class="hw-stat">
                    <span class="hw-label">GPU</span>
                    <div class="hw-bar"><div class="hw-fill" id="gpuBar"></div></div>
                    <span class="hw-value" id="gpuValue">0%</span>
                </div>
                <div class="hw-stat">
                    <span class="hw-label">RAM</span>
                    <div class="hw-bar"><div class="hw-fill" id="ramBar"></div></div>
                    <span class="hw-value" id="ramValue">0GB</span>
                </div>
                <div class="hw-stat">
                    <span class="hw-label">Temp</span>
                    <span class="hw-temp" id="tempValue">--¬∞C</span>
                </div>
            </div>
        </div>

        <!-- Work Mode Desktop View -->
        <div class="work-desktop" id="workDesktop" style="display: none;">
            <div class="work-header">
                <h2>üñ•Ô∏è AI Desktop - Task Workspace</h2>
                <button class="work-close" id="workCloseBtn">√ó</button>
            </div>
            <div class="work-content">
                <div class="work-panel">
                    <h3>üìã Current Task</h3>
                    <div id="currentTask" class="task-display">Waiting for task...</div>
                </div>
                <div class="work-panel">
                    <h3>üîç Search Results</h3>
                    <div id="searchResults" class="results-display"></div>
                </div>
                <div class="work-panel">
                    <h3>üìÑ Documents</h3>
                    <div id="workDocuments" class="docs-display"></div>
                </div>
                <div class="work-panel full-width">
                    <h3>üí≠ Thinking Process</h3>
                    <div id="thinkingLog" class="log-display"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
            </svg>
        </button>
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <rect width="32" height="32" rx="8" fill="url(#gradient)"/>
                        <path d="M10 12h12M10 16h12M10 20h8" stroke="white" stroke-width="2" stroke-linecap="round"/>
                        <defs>
                            <linearGradient id="gradient" x1="0" y1="0" x2="32" y2="32">
                                <stop offset="0%" stop-color="#667eea"/>
                                <stop offset="100%" stop-color="#764ba2"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <h1>EDISON</h1>
                </div>
                <button class="new-chat-btn" id="newChatBtn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 5v10M5 10h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    New Chat
                </button>
                
                <!-- Gallery Button -->
                <button class="gallery-btn" id="galleryBtn" title="View generated images" onclick="event.stopPropagation(); event.preventDefault(); console.log('CLICK EVENT'); if(window.imageGallery) { if(window.imageGallery.isOpen) { window.imageGallery.close(); } else { window.imageGallery.open(); } }">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <rect x="2" y="3" width="16" height="11" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                        <circle cx="7" cy="7" r="1.5" fill="currentColor"/>
                        <path d="M2 13l4-4 3 3 4-5 5 6" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    </svg>
                    Gallery
                </button>
                
                <!-- 3D Model Generation Button -->
                <button class="sidebar-feature-btn" id="threeDBtn" title="Generate 3D models" onclick="event.stopPropagation(); window.toggle3DPanel && window.toggle3DPanel();">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M10 2L18 7V13L10 18L2 13V7L10 2Z"/>
                        <path d="M10 18V12"/>
                        <path d="M18 7L10 12L2 7"/>
                    </svg>
                    3D Models
                </button>

                <!-- Minecraft Tools Button -->
                <button class="sidebar-feature-btn" id="minecraftBtn" title="Minecraft 1.7.10 Tools" onclick="event.stopPropagation(); window.toggleMinecraftPanel && window.toggleMinecraftPanel();">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="14" height="14" rx="1"/>
                        <rect x="6" y="6" width="3" height="3"/>
                        <rect x="11" y="6" width="3" height="3"/>
                        <rect x="6" y="11" width="3" height="3"/>
                        <rect x="11" y="11" width="3" height="3"/>
                    </svg>
                    Minecraft
                </button>

                <!-- File Manager Button -->
                <button class="sidebar-feature-btn" id="fileManagerBtn" title="Data Management Console" onclick="event.stopPropagation(); window.toggleFileManager && window.toggleFileManager();">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M2 5C2 4 3 3 4 3H8L10 5H16C17 5 18 6 18 7V15C18 16 17 17 16 17H4C3 17 2 16 2 15V5Z"/>
                    </svg>
                    Files
                </button>
            </div>
            
            <!-- Search bar for chat history -->
            <div class="chat-search">
                <input type="text" id="chatSearchInput" placeholder="Search conversations..." />
                <svg class="search-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <circle cx="6.5" cy="6.5" r="5" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <path d="M10 10l4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </div>
            
            <div class="chat-history" id="chatHistory">
                <!-- Chat history items will be inserted here -->
            </div>
            
            <div class="sidebar-footer">
                <button class="settings-btn" id="settingsBtn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 3a7 7 0 100 14 7 7 0 000-14zm0 2a5 5 0 110 10 5 5 0 010-10z"/>
                    </svg>
                    Settings
                </button>
                <button class="monitor-btn" id="monitorBtn" title="Toggle system monitor" onclick="event.stopPropagation(); window.toggleHardwareMonitor && window.toggleHardwareMonitor(event);">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <rect x="2" y="3" width="16" height="11" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                        <path d="M7 17h6M10 14v3" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Chat Header Bar -->
            <div class="chat-header-bar">
                <div class="chat-user-switcher">
                    <label for="chatUserSelect" class="chat-user-label">üë§</label>
                    <select id="chatUserSelect" class="chat-user-select" title="Switch user"></select>
                    <button class="chat-user-add-btn" id="chatAddUserBtn" title="Add new user">+</button>
                    <button class="chat-user-delete-btn" id="chatDeleteUserBtn" title="Delete selected user">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 4h12M5.33 4V2.67a1.33 1.33 0 011.34-1.34h2.66a1.33 1.33 0 011.34 1.34V4M12.67 4v9.33a1.33 1.33 0 01-1.34 1.34H4.67a1.33 1.33 0 01-1.34-1.34V4h9.34z"/>
                            <path d="M6.67 7.33v4M9.33 7.33v4"/>
                        </svg>
                    </button>
                    <button class="chat-user-add-btn" id="chatCleanUsersBtn" title="Remove auto-generated users">üßπ</button>
                </div>
            </div>
            <div class="chat-container">
                <div class="messages-container" id="messagesContainer">
                    <div class="welcome-screen" id="welcomeScreen">
                        <h2>Welcome to EDISON</h2>
                        <p>Your offline AI assistant for conversations, code, and creative tasks</p>
                        
                        <div class="capabilities">
                            <div class="capability-card">
                                <div class="capability-icon">üí¨</div>
                                <h3>Natural Conversations</h3>
                                <p>Chat naturally with fast responses using the 14B model</p>
                            </div>
                            <div class="capability-card">
                                <div class="capability-icon">üß†</div>
                                <h3>Deep Thinking</h3>
                                <p>Get detailed analysis with the powerful 72B model</p>
                            </div>
                            <div class="capability-card">
                                <div class="capability-icon">üíª</div>
                                <h3>Code Assistant</h3>
                                <p>Write, debug, and explain code in multiple languages</p>
                            </div>
                            <div class="capability-card">
                                <div class="capability-icon">ü§ñ</div>
                                <h3>Agent Mode</h3>
                                <p>Execute complex tasks with tool-using capabilities</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="artifacts-panel" id="artifactsPanel" style="display: none;">
                    <div class="artifact-header">
                        <span id="artifactTitle">Artifact</span>
                        <div class="artifact-actions">
                            <button id="artifactCopyBtn" title="Copy">üìã</button>
                            <button id="artifactDownloadBtn" title="Download">üíæ</button>
                            <button id="artifactCloseBtn" title="Close">‚úï</button>
                        </div>
                    </div>
                    <div class="artifact-content">
                        <pre><code id="artifactCode"></code></pre>
                    </div>
                </div>

                <div class="input-container">
                    <div class="input-wrapper">
                        <div class="mode-selector">
                            <button class="mode-btn active" data-mode="auto" title="Auto-detect intent">
                                <span class="mode-icon">üîÆ</span>
                                <span class="mode-label">Auto</span>
                            </button>
                            <button class="mode-btn" data-mode="instant" title="Instant response">
                                <span class="mode-icon">‚ö°</span>
                                <span class="mode-label">Instant</span>
                            </button>
                            <button class="mode-btn" data-mode="thinking" title="Extended reasoning">
                                <span class="mode-icon">üß©</span>
                                <span class="mode-label">Thinking</span>
                            </button>
                            <button class="mode-btn" data-mode="chat" title="Fast responses (14B)">
                                <span class="mode-icon">üí¨</span>
                                <span class="mode-label">Chat</span>
                            </button>
                            <button class="mode-btn" data-mode="reasoning" title="Reasoning mode (QwQ-32B)">
                                <span class="mode-icon">üß†</span>
                                <span class="mode-label">Reasoning</span>
                            </button>
                            <button class="mode-btn" data-mode="code" title="Code assistance">
                                <span class="mode-icon">üíª</span>
                                <span class="mode-label">Code</span>
                            </button>
                            <button class="mode-btn" data-mode="agent" title="Tool-using agent">
                                <span class="mode-icon">ü§ñ</span>
                                <span class="mode-label">Agent</span>
                            </button>
                            <button class="mode-btn" data-mode="swarm" title="Parallel specialized agents">
                                <span class="mode-icon">üï∏Ô∏è</span>
                                <span class="mode-label">Swarm</span>
                            </button>
                            <button class="mode-btn" data-mode="work" title="Work mode with task visualization">
                                <span class="mode-icon">üñ•Ô∏è</span>
                                <span class="mode-label">Work</span>
                            </button>
                        </div>
                        
                        <div class="input-area">
                            <input type="file" id="fileInput" multiple style="display: none;" accept="*/*" />
                            <button class="attach-btn" id="attachBtn" title="Upload files (text, code, images)" onclick="event.stopPropagation(); window.triggerFileUpload && window.triggerFileUpload(event);">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10 3v14M3 10h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                            <button class="voice-btn" id="voiceBtn" title="Voice input">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10 12a3 3 0 0 0 3-3V5a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3z"/>
                                    <path d="M4 9a6 6 0 0 0 12 0h-2a4 4 0 0 1-8 0H4z"/>
                                    <path d="M10 15v3M7 18h6" stroke="currentColor" stroke-width="1"/>
                                </svg>
                            </button>
                            <textarea 
                                id="messageInput" 
                                placeholder="Message EDISON..." 
                                rows="1"
                                maxlength="4000"
                            ></textarea>
                            <button class="send-btn" id="sendBtn" disabled>
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 10l16-8-8 16-2-8-6-0z"/>
                                </svg>
                            </button>
                            <button class="stop-btn" id="stopBtn" style="display: none;">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <rect x="5" y="5" width="10" height="10" rx="1"/>
                                </svg>
                            </button>
                        </div>
                        <div class="attached-files" id="attachedFiles" style="display: none;">
                            <!-- Attached files will appear here -->
                        </div>
                        
                        <div class="input-footer">
                            <div class="auto-memory-indicator" title="EDISON automatically remembers important conversations">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.6;">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                </svg>
                                <span style="opacity: 0.6; font-size: 12px;">Auto memory enabled</span>
                            </div>
                            <span class="char-count" id="charCount">0 / 4000</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Settings Modal -->
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Settings</h2>
                    <button class="close-btn" id="closeSettingsBtn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="setting-group">
                        <label for="apiEndpoint">API Endpoint</label>
                        <input type="text" id="apiEndpoint" value="http://192.168.1.26:8811" placeholder="http://localhost:8811">
                        <p class="setting-description">The URL of your EDISON Core service</p>
                    </div>
                    
                    <div class="setting-group">
                        <label for="comfyuiEndpoint">ComfyUI Endpoint</label>
                        <input type="text" id="comfyuiEndpoint" value="http://192.168.1.26:8188" placeholder="http://localhost:8188">
                        <p class="setting-description">The URL of your ComfyUI service (for image generation)</p>
                    </div>

                    <div class="setting-group">
                        <label for="voiceEndpoint">Voice Endpoint</label>
                        <input type="text" id="voiceEndpoint" value="http://192.168.1.26:8809" placeholder="http://localhost:8809">
                        <p class="setting-description">The URL of your voice service (speech-to-text)</p>
                    </div>
                    
                    <div class="setting-group">
                        <label>Theme</label>
                        <div class="theme-toggle">
                            <button class="theme-btn active" data-theme="dark" id="darkThemeBtn">üåô Dark</button>
                            <button class="theme-btn" data-theme="light" id="lightThemeBtn">‚òÄÔ∏è Light</button>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label>Color Scheme</label>
                        <div class="color-palette">
                            <button class="color-btn default active" data-color="default" title="Default (Indigo)"></button>
                            <button class="color-btn blue" data-color="blue" title="Blue"></button>
                            <button class="color-btn purple" data-color="purple" title="Purple"></button>
                            <button class="color-btn cyan" data-color="cyan" title="Cyan"></button>
                            <button class="color-btn emerald" data-color="emerald" title="Emerald"></button>
                            <button class="color-btn rose" data-color="rose" title="Rose"></button>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label for="defaultMode">Default Mode</label>
                        <select id="defaultMode">
                            <option value="auto">Auto (Intent Detection)</option>
                            <option value="instant">Instant (Quick Response)</option>
                            <option value="thinking">Thinking (Extended Reasoning)</option>
                            <option value="chat">Chat (14B Fast)</option>
                            <option value="reasoning">Reasoning (QwQ-32B)</option>
                            <option value="code">Code Assistant</option>
                            <option value="agent">Agent Mode</option>
                            <option value="work">Work (Multi-Step)</option>
                            <option value="swarm">Swarm (Parallel Agents)</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="streamResponses" checked>
                            Stream responses (when available)
                        </label>
                    </div>
                    
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="syntaxHighlight" checked>
                            Enable syntax highlighting for code
                        </label>
                    </div>

                    <div class="setting-group">
                        <h3>Model Hot-Swap</h3>
                        <div class="user-id-container">
                            <input type="text" id="modelNameInput" placeholder="Model name (e.g., qwq-32b)" style="flex: 1;">
                        </div>
                        <div class="user-id-container" style="margin-top: 8px;">
                            <input type="text" id="modelPathInput" placeholder="Model path (/opt/edison/models/llm/...)" style="flex: 1;">
                        </div>
                        <div class="user-id-container" style="margin-top: 8px;">
                            <input type="number" id="modelCtxInput" placeholder="Context window (e.g., 32768)" style="flex: 1;">
                            <input type="text" id="modelTensorInput" placeholder="Tensor split (e.g., 0.55,0.30,0.15)" style="flex: 1;">
                        </div>
                        <div class="user-id-container" style="margin-top: 8px;">
                            <button class="btn-secondary" id="loadModelBtn" title="Load model">‚¨ÜÔ∏è Load</button>
                            <button class="btn-secondary" id="unloadModelBtn" title="Unload model">‚¨áÔ∏è Unload</button>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <h3>System Status</h3>
                        <div class="status-indicator" id="systemStatus">
                            <span class="status-dot"></span>
                            <span class="status-text">Checking...</span>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <h3>Sync Settings</h3>
                        <p class="setting-description">Your chats are synced to the server. To access your chats from another device, copy this User ID:</p>
                        <div class="user-id-container">
                            <input type="text" id="userIdInput" readonly style="flex: 1; font-family: monospace; font-size: 12px;">
                            <button class="btn-secondary" id="copyUserIdBtn" title="Copy User ID">üìã Copy</button>
                        </div>
                        <p class="setting-description" style="margin-top: 8px;">To restore chats on this device from another, paste the User ID below:</p>
                        <div class="user-id-container">
                            <input type="text" id="importUserIdInput" placeholder="Paste User ID here" style="flex: 1; font-family: monospace; font-size: 12px;">
                            <button class="btn-secondary" id="importUserIdBtn" title="Import User ID">üì• Import</button>
                        </div>
                        <p class="setting-description" style="margin-top: 12px;">Manage users and switch between them:</p>
                        <div class="user-id-container">
                            <select id="userSelect" style="flex: 1;"></select>
                            <button class="btn-secondary" id="refreshUsersBtn" title="Refresh users">üîÑ</button>
                        </div>
                        <div class="user-id-container" style="margin-top: 8px;">
                            <input type="text" id="newUserNameInput" placeholder="New user name" style="flex: 1;">
                            <button class="btn-secondary" id="addUserBtn" title="Add user">‚ûï Add</button>
                        </div>
                        <div class="user-id-container" style="margin-top: 8px;">
                            <input type="text" id="renameUserInput" placeholder="Rename selected user" style="flex: 1;">
                            <button class="btn-secondary" id="renameUserBtn" title="Rename user">‚úèÔ∏è Rename</button>
                            <button class="btn-secondary" id="deleteUserBtn" title="Delete user">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="clearHistoryBtn">Clear Chat History</button>
                    <button class="btn-primary" id="saveSettingsBtn">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="settings-close-btn" id="settingCloseBtn">√ó</button>
            </div>
            <div class="settings-content">
                <!-- Theme Selection -->
                <div class="settings-group">
                    <label class="settings-group-label">Theme</label>
                    <div class="theme-toggle">
                        <button class="theme-btn active" data-theme="dark" id="darkThemeBtn">üåô Dark</button>
                        <button class="theme-btn" data-theme="light" id="lightThemeBtn">‚òÄÔ∏è Light</button>
                    </div>
                </div>

                <!-- Color Selection -->
                <div class="settings-group">
                    <label class="settings-group-label">Color Scheme</label>
                    <div class="color-palette">
                        <button class="color-btn default active" data-color="default" title="Default (Indigo)"></button>
                        <button class="color-btn blue" data-color="blue" title="Blue"></button>
                        <button class="color-btn purple" data-color="purple" title="Purple"></button>
                        <button class="color-btn cyan" data-color="cyan" title="Cyan"></button>
                        <button class="color-btn emerald" data-color="emerald" title="Emerald"></button>
                        <button class="color-btn rose" data-color="rose" title="Rose"></button>
                    </div>
                </div>

                <!-- Device Info -->
                <div class="settings-group">
                    <label class="settings-group-label">Device Info</label>
                    <div style="padding: 12px; background: var(--surface-hover); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                        <div style="margin-bottom: 6px;"><strong>Type:</strong> <span id="deviceType">Loading...</span></div>
                        <div style="margin-bottom: 6px;"><strong>Screen:</strong> <span id="screenSize">Loading...</span></div>
                        <div style="margin-bottom: 6px;"><strong>Orientation:</strong> <span id="deviceOrientation">Loading...</span></div>
                        <div><strong>API:</strong> <span id="apiEndpoint">Loading...</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3D Model Generation Panel -->
    <div class="feature-panel" id="threeDPanel" style="transform: translateX(100%); visibility: hidden;">
        <div class="feature-panel-header">
            <h2>üßä 3D Model Generator</h2>
            <button class="feature-panel-close" onclick="window.toggle3DPanel && window.toggle3DPanel();">√ó</button>
        </div>
        <div class="feature-panel-body">
            <div class="feature-section">
                <label class="feature-label">Input Method</label>
                <div class="feature-toggle-row">
                    <button class="feature-toggle active" data-3d-mode="text" onclick="window.set3DMode && window.set3DMode('text')">Text Prompt</button>
                    <button class="feature-toggle" data-3d-mode="image" onclick="window.set3DMode && window.set3DMode('image')">From Image</button>
                </div>
            </div>
            <div class="feature-section" id="threeDTextInput">
                <label class="feature-label">Describe the 3D model</label>
                <textarea id="threeDPrompt" class="feature-textarea" placeholder="e.g., A low-poly treasure chest with gold trim..." rows="3"></textarea>
            </div>
            <div class="feature-section" id="threeDImageInput" style="display: none;">
                <label class="feature-label">Upload Reference Image</label>
                <div class="feature-dropzone" id="threeDDropzone">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 16V8m0 0l-4 4m4-4l4 4"/><rect x="3" y="3" width="18" height="18" rx="3"/></svg>
                    <p>Drop image here or click to upload</p>
                    <input type="file" id="threeDImageFile" accept="image/*" style="display:none;">
                </div>
                <div id="threeDImagePreview" style="display:none;" class="feature-img-preview"></div>
            </div>
            <div class="feature-section">
                <label class="feature-label">Output Format</label>
                <select id="threeDFormat" class="feature-select">
                    <option value="glb">GLB (recommended)</option>
                    <option value="obj">OBJ</option>
                    <option value="ply">PLY</option>
                </select>
            </div>
            <div class="feature-section">
                <label class="feature-label">Quality Steps: <span id="threeDStepsVal">64</span></label>
                <input type="range" id="threeDSteps" class="feature-range" min="16" max="128" value="64" oninput="document.getElementById('threeDStepsVal').textContent=this.value">
            </div>
            <div class="feature-section">
                <label class="feature-label">Guidance Scale: <span id="threeDGuidanceVal">15.0</span></label>
                <input type="range" id="threeDGuidance" class="feature-range" min="1" max="20" step="0.5" value="15" oninput="document.getElementById('threeDGuidanceVal').textContent=parseFloat(this.value).toFixed(1)">
            </div>
            <button class="feature-generate-btn" id="threeDGenerateBtn" onclick="window.generate3DModel && window.generate3DModel();">
                üßä Generate 3D Model
            </button>
            <div class="feature-status" id="threeDStatus" style="display:none;"></div>

            <!-- Live 3D Viewport -->
            <div class="viewer3d-container" id="threeDViewerContainer" style="display:none;">
                <div class="viewer3d-header">
                    <span class="viewer3d-title">üßä 3D Preview</span>
                    <div class="viewer3d-controls">
                        <button class="viewer3d-ctrl-btn" onclick="window.viewer3DResetCamera && window.viewer3DResetCamera()" title="Reset camera">üîÑ</button>
                        <button class="viewer3d-ctrl-btn" onclick="window.viewer3DToggleWireframe && window.viewer3DToggleWireframe()" title="Toggle wireframe">üî≤</button>
                        <button class="viewer3d-ctrl-btn" onclick="window.viewer3DToggleAutoRotate && window.viewer3DToggleAutoRotate()" title="Toggle auto-rotate">üîÅ</button>
                        <button class="viewer3d-ctrl-btn" onclick="window.viewer3DFullscreen && window.viewer3DFullscreen()" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="viewer3d-canvas-wrap" id="threeDCanvasWrap">
                    <canvas id="threeDCanvas"></canvas>
                    <div class="viewer3d-overlay" id="threeDOverlay">
                        <div class="viewer3d-progress">
                            <div class="viewer3d-progress-ring">
                                <svg viewBox="0 0 100 100">
                                    <circle class="ring-bg" cx="50" cy="50" r="45"/>
                                    <circle class="ring-fg" id="threeDProgressRing" cx="50" cy="50" r="45"/>
                                </svg>
                                <span class="ring-pct" id="threeDProgressPct">0%</span>
                            </div>
                            <p class="viewer3d-progress-text" id="threeDProgressText">Initializing...</p>
                        </div>
                    </div>
                </div>
                <div class="viewer3d-info">
                    <span id="threeDViewerInfo">Drag to rotate ¬∑ Scroll to zoom ¬∑ Right-click to pan</span>
                </div>
            </div>

            <div class="feature-results" id="threeDResults"></div>
        </div>
    </div>

    <!-- Minecraft Tools Panel -->
    <div class="feature-panel" id="minecraftPanel" style="transform: translateX(100%); visibility: hidden;">
        <div class="feature-panel-header mc-header">
            <h2>‚õèÔ∏è Minecraft 1.7.10 Tools</h2>
            <button class="feature-panel-close" onclick="window.toggleMinecraftPanel && window.toggleMinecraftPanel();">√ó</button>
        </div>
        <div class="feature-panel-body">
            <!-- Tab Selector -->
            <div class="mc-tabs">
                <button class="mc-tab active" data-mc-tab="textures" onclick="window.switchMCTab && window.switchMCTab('textures')">üé® Textures</button>
                <button class="mc-tab" data-mc-tab="models" onclick="window.switchMCTab && window.switchMCTab('models')">üß± Models</button>
                <button class="mc-tab" data-mc-tab="gallery" onclick="window.switchMCTab && window.switchMCTab('gallery')">üì¶ Gallery</button>
            </div>

            <!-- Texture Generation Tab -->
            <div class="mc-tab-content active" id="mcTexturesTab">
                <div class="feature-section">
                    <label class="feature-label">Texture Type</label>
                    <select id="mcTextureType" class="feature-select">
                        <option value="block">üß± Block</option>
                        <option value="item">üó°Ô∏è Item</option>
                        <option value="crop">üåæ Crop</option>
                        <option value="skin">üë§ Skin</option>
                        <option value="mob">üê∫ Mob</option>
                        <option value="armor">üõ°Ô∏è Armor</option>
                        <option value="gui">üìã GUI Element</option>
                        <option value="particle">‚ú® Particle</option>
                        <option value="environment">üåç Environment</option>
                    </select>
                </div>
                <div class="feature-section">
                    <label class="feature-label">Style</label>
                    <select id="mcStyle" class="feature-select">
                        <option value="pixel_art">Pixel Art (Classic)</option>
                        <option value="faithful">Faithful (Detailed)</option>
                        <option value="painterly">Painterly (Soft)</option>
                    </select>
                </div>
                <div class="feature-section">
                    <label class="feature-label">Resolution</label>
                    <select id="mcResolution" class="feature-select">
                        <option value="16">16√ó16 (Default)</option>
                        <option value="32">32√ó32 (HD)</option>
                        <option value="64">64√ó64 (Ultra)</option>
                        <option value="128">128√ó128 (Extreme)</option>
                    </select>
                </div>
                <div class="feature-section">
                    <label class="feature-label">Describe
 your texture</label>
                    <textarea id="mcPrompt" class="feature-textarea" placeholder="e.g., Ruby ore block with red crystals in stone..." rows="3"></textarea>
                </div>
                <div class="feature-section">
                    <label class="feature-label">Reference Image (optional)</label>
                    <div class="feature-dropzone small" id="mcDropzone">
                        <p>üìé Drop image or click</p>
                        <input type="file" id="mcImageFile" accept="image/*" style="display:none;">
                    </div>
                    <div id="mcImagePreview" style="display:none;" class="feature-img-preview"></div>
                </div>
                <button class="feature-generate-btn mc-btn" id="mcGenerateBtn" onclick="window.generateMinecraftTexture && window.generateMinecraftTexture();">
                    ‚õèÔ∏è Generate Texture
                </button>
                <div class="feature-status" id="mcTextureStatus" style="display:none;"></div>
            </div>

            <!-- Model Generation Tab -->
            <div class="mc-tab-content" id="mcModelsTab" style="display:none;">
                <div class="feature-section">
                    <label class="feature-label">Select a Generated Texture</label>
                    <select id="mcModelTexture" class="feature-select">
                        <option value="">-- Generate a texture first --</option>
                    </select>
                </div>
                <div class="feature-section">
                    <label class="feature-label">Model Type</label>
                    <select id="mcModelType" class="feature-select">
                        <option value="block">üß± Full Block</option>
                        <option value="item">üó°Ô∏è Item</option>
                        <option value="crop">üåæ Crop</option>
                        <option value="slab">üìê Slab</option>
                        <option value="stairs">ü™ú Stairs</option>
                        <option value="fence">üèóÔ∏è Fence</option>
                        <option value="wall">üß± Wall</option>
                        <option value="cross">‚úñÔ∏è Cross (Flowers)</option>
                        <option value="pane">ü™ü Pane (Glass)</option>
                    </select>
                </div>
                <div class="feature-section">
                    <label class="feature-label">Block/Item Name</label>
                    <input type="text" id="mcModelName" class="feature-input" placeholder="e.g., ruby_ore">
                </div>
                <button class="feature-generate-btn mc-btn" id="mcModelGenBtn" onclick="window.generateMinecraftModel && window.generateMinecraftModel();">
                    üß± Generate Model Package
                </button>
                <div class="feature-status" id="mcModelStatus" style="display:none;"></div>

                <!-- Minecraft 3D Block Preview -->
                <div class="mc-3d-preview" id="mc3DPreview" style="display:none;">
                    <div class="viewer3d-header mc-viewer-header">
                        <span class="viewer3d-title">üß± Block Preview</span>
                        <div class="viewer3d-controls">
                            <button class="viewer3d-ctrl-btn" onclick="window.mcResetCamera && window.mcResetCamera()" title="Reset">üîÑ</button>
                            <button class="viewer3d-ctrl-btn" onclick="window.mcToggleAutoRotate && window.mcToggleAutoRotate()" title="Auto-rotate">üîÅ</button>
                        </div>
                    </div>
                    <div class="viewer3d-canvas-wrap mc-canvas-wrap" id="mcCanvasWrap">
                        <canvas id="mcPreviewCanvas"></canvas>
                    </div>
                    <div class="viewer3d-info">
                        <span>Drag to rotate ¬∑ Scroll to zoom</span>
                    </div>
                </div>
            </div>

            <!-- Gallery Tab -->
            <div class="mc-tab-content" id="mcGalleryTab" style="display:none;">
                <div class="mc-gallery-grid" id="mcGalleryGrid">
                    <p class="mc-empty">No Minecraft assets generated yet. Create some textures!</p>
                </div>
            </div>

            <!-- Install Status -->
            <div class="mc-install-status" id="mcInstallStatus"></div>
        </div>
    </div>

    <!-- File Manager Panel -->
    <div class="feature-panel file-manager-panel" id="fileManagerPanel" style="transform: translateX(100%); visibility: hidden;">
        <div class="feature-panel-header fm-header">
            <h2>üìÅ Data Management Console</h2>
            <button class="feature-panel-close" onclick="window.toggleFileManager && window.toggleFileManager();">√ó</button>
        </div>
        <div class="feature-panel-body fm-body">
            <!-- Storage Overview -->
            <div class="fm-storage-section" id="fmStorageSection">
                <h3 class="fm-section-title">üíæ Storage Drives</h3>
                <div class="fm-drives" id="fmDrives">
                    <div class="fm-loading">Loading drives...</div>
                </div>
            </div>

            <!-- File Browser -->
            <div class="fm-browser-section">
                <!-- Breadcrumb -->
                <div class="fm-breadcrumb" id="fmBreadcrumb">
                    <span class="fm-crumb" onclick="window.fmNavigate && window.fmNavigate('')">üè† EDISON</span>
                </div>

                <!-- Search -->
                <div class="fm-search">
                    <input type="text" id="fmSearch" class="feature-input" placeholder="üîç Search files..." onkeyup="window.fmSearchFiles && window.fmSearchFiles(this.value)">
                </div>

                <!-- File List -->
                <div class="fm-file-list" id="fmFileList">
                    <div class="fm-loading">Loading files...</div>
                </div>
            </div>

            <!-- Delete Confirmation -->
            <div class="fm-delete-confirm" id="fmDeleteConfirm" style="display:none;">
                <div class="fm-delete-dialog">
                    <h3>‚ö†Ô∏è Confirm Delete</h3>
                    <p id="fmDeleteMsg">Are you sure?</p>
                    <div class="fm-delete-actions">
                        <button class="fm-btn fm-btn-cancel" onclick="window.fmCancelDelete && window.fmCancelDelete();">Cancel</button>
                        <button class="fm-btn fm-btn-delete" onclick="window.fmConfirmDelete && window.fmConfirmDelete();">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gallery Panel - Placed outside app-container to avoid flex layout interference -->
    <div class="gallery-panel" id="galleryPanel" style="transform: translateX(100%); visibility: hidden;">
        <div class="gallery-header">
            <h2>üñºÔ∏è Image Gallery</h2>
            <button class="gallery-close-btn" id="galleryCloseBtn" onclick="if(window.imageGallery) window.imageGallery.close();">√ó</button>
        </div>
        <div class="gallery-content" id="galleryContent">
            <div class="gallery-loading" id="galleryLoading">
                <div class="loading-spinner"></div>
                <p>Loading images...</p>
            </div>
            <div class="gallery-empty" id="galleryEmpty" style="display: none;">
                <svg width="64" height="64" viewBox="0 0 64 64" fill="currentColor" style="opacity: 0.3;">
                    <rect x="8" y="12" width="48" height="36" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                    <circle cx="20" cy="24" r="4" fill="currentColor"/>
                    <path d="M8 44l12-12 8 8 12-16 16 20" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
                <h3>No images yet</h3>
                <p>Generated images will appear here</p>
            </div>
            <div class="gallery-grid" id="galleryGrid">
                <!-- Images will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Global function to download images
        function downloadImage(url, filename) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const blobUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(blobUrl);
                })
                .catch(error => console.error('Download failed:', error));
        }

        // Global function to regenerate images
        function regenerateImage(prompt) {
            // Access the app instance and trigger regeneration
            if (window.edisonApp) {
                // Set the message input to the prompt
                window.edisonApp.messageInput.value = `generate an image of ${prompt}`;
                // Trigger send
                window.edisonApp.sendMessage();
            }
        }

        // Global function to copy code to clipboard
        window.copyCodeToClipboard = function(button) {
            const wrapper = button.closest('.code-block-wrapper');
            const codeElement = wrapper.querySelector('code');
            const code = codeElement.textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                // Change button text to "Copied!"
                const originalHTML = button.innerHTML;
                button.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M3 8L6 11L13 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Copied!`;
                button.classList.add('copied');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code:', err);
            });
        }
    </script>

    <script src="gallery.js?v=13"></script>
    <script src="app_enhanced.js?v=15"></script>
    <script src="app_features.js?v=7"></script>
    <script src="app_new_features.js?v=1"></script>
</body>
</html>
